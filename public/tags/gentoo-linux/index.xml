<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>Gentoo Linux - Tag - 索元的博客</title>
        <link>http://localhost:1313/tags/gentoo-linux/</link>
        <description>Gentoo Linux - Tag - 索元的博客</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>s5n666@outlook.com (suo yuan)</managingEditor>
            <webMaster>s5n666@outlook.com (suo yuan)</webMaster><lastBuildDate>Tue, 07 Jan 2025 10:00:36 &#43;0000</lastBuildDate><atom:link href="http://localhost:1313/tags/gentoo-linux/" rel="self" type="application/rss+xml" /><item>
    <title>Gentoo Linux 安全加固指南</title>
    <link>http://localhost:1313/posts/gentoo_hardened_guide/</link>
    <pubDate>Tue, 07 Jan 2025 10:00:36 &#43;0000</pubDate>
    <author>suo yuan</author>
    <guid>http://localhost:1313/posts/gentoo_hardened_guide/</guid>
    <description><![CDATA[<h1 id="gentoo-linux-安全加固指南">Gentoo Linux 安全加固指南</h1>
<blockquote>
<ul>
<li>2025 年 1 月 8/9/10 号修改
<ul>
<li>添加了 VSCodium 的 bwrap 启动参数</li>
<li>修改了 sysctl 和内核启动参数部分</li>
<li>添加了 Chromium 的 bwrap 启动参数</li>
<li>添加了 NetworkManager 部分</li>
</ul>
</li>
<li>2025 年 1 月 13 号修改
<ul>
<li>修改了bwrap 中 FireFox 部分，让它可以响应 <code>xdg-open</code></li>
<li>添加了禁止核心转储 (core dump) 的段落</li>
<li>添加了面向安全的编译选项部分</li>
</ul>
</li>
<li>2025 年 1 月 19 号修改
<ul>
<li>添加了 NetworkManager 下开启 IPV6 隐私扩展的描述</li>
<li>修改了 编译选项 的部分</li>
</ul>
</li>
<li>2025 年 1 月 27/28 号修改
<ul>
<li>在 sysctl 和内核参数部分添加了更多的解释</li>
<li>修改了文章中部分语句不通，不好理解的地方</li>
</ul>
</li>
</ul>
</blockquote>
<p>我一直在寻求一个尽可能不影响日常使用的同时尽量做到安全的操作系统。</p>
<p>单论安全性，我认为 <a href="https://www.qubes-os.org/" target="_blank" rel="noopener noreffer ">Qubes OS</a> 很不错，但是网络配置看起来不是很容易，并且社区貌似不是很大。</p>
<p>Fedora Silverblue 也是个不错的选择，原子更新，桌面应用大多是从 Flatpak 安装，不过我对 Fedora 官方软件仓库没有我想要的软件这一情况一直有些介意，虽然有 COPR 源，但我不是特别想用。</p>
<p>NixOS 也是个选择，同样是不可变发行版，nixpkg 提供了很多软件包，包括 linux-hardened、hardened-malloc 等，NixOS 官方有一套 security profile，不过我还没尝试，印象中是使用了 linux-hardened 内核，启用了一些安全相关的 sysctl 设置，将内存分配器改成 scudo（好像还启用了 AppArmor？）</p>
<p>我目前认为 Gentoo Linux 是一个不错的选择，但由于 Gentoo Linux 编译真的很费时间，所以我放假回来才开始尝试一些我以前想过但没尝试的功能。</p>
<h2 id="硬盘加密">硬盘加密</h2>
<p>我现在认为硬盘加密是一个必须的选择。我选择了 Luks2 的 argon2id 算法，这导致我需要使用 systemd-boot，GRUB 对 Luks2 的支持有限。</p>
<p>在硬盘分区时，根据 <a href="https://wiki.gentoo.org/wiki/Rootfs_encryption" target="_blank" rel="noopener noreffer ">Rootfs_encryption</a>，直接执行：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cryptsetup --type luks2 --cipher aes-xts-plain64 --hash sha512 --iter-time <span class="m">5000</span> --key-size <span class="m">256</span> --pbkdf argon2id --use-urandom --verify-passphrase luksFormat /dev/block</span></span></code></pre></div></div>
<p>如何你想使用 GRUB 作为 bootloader（比如你有引导 windows 启动项的需求等），那就不能使用 luks2，应该选择用 luks 的算法。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cryptsetup luksOpen /dev/block root
</span></span><span class="line"><span class="cl">$ mkfs.xfs -L rootfs /dev/mapper/root
</span></span><span class="line"><span class="cl">$ mount --label rootfs /mnt/gentoo</span></span></code></pre></div></div>
<p>这样就可以将其格式化成 XFS 文件系统了，我没有使用 SWAP 分区，我选择了使用 ZRAM 做交换分区，不过加密的 SWAP 倒也是个选择，只是我没这么做。</p>
<p>之后你需要附加相关命令行参数用于解锁：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ lsblk -o name,uuid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME        UUID
</span></span><span class="line"><span class="cl">sdb                                           
</span></span><span class="line"><span class="cl">├─nvme0n1p1 BDF2-0139
</span></span><span class="line"><span class="cl">├─nvme0n1p2 b0e86bef-30f8-4e3b-ae35-3fa2c6ae705b
</span></span><span class="line"><span class="cl">└─nvme0n1p3 4bb45bd6-9ed9-44b3-b547-b411079f043b
</span></span><span class="line"><span class="cl">  └─root    cb070f9e-da0e-4bc5-825c-b01bb2707704</span></span></code></pre></div></div>
<p>假设输出是上面这样，那么应该在 <strong>/etc/dracut.conf.d/luks.conf</strong> 下写入：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-txt">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">kernel_cmdline+=&#34; root=UUID=cb070f9e-da0e-4bc5-825c-b01bb2707704 rd.luks.uuid=4bb45bd6-9ed9-44b3-b547-b411079f043b &#34;</span></span></code></pre></div></div>
<h2 id="安全启动">安全启动</h2>
<p>安全启动是个耳熟能详的名词，我在刚接触到给自己的笔记本电脑安装 GNU/Linux 发行版的教程的时候，一般都会说明首先要在 BIOS 中关闭快速启动和安全启动，部分社区支持的发行版无法在开启安全启动的情况下安装（不过可以安装时/后开启安全启动的支持），商业公司支持的（如 Fedora，OpenSUSE，Deepin 等）发行版应该是都可以直接启动安装。</p>
<p>安全启动是 UEFI 下才有的安全验证机制，旨在确保引导的操作系统是可信的。</p>
<p>只需要在安装的过程中对照着手册，看到安全启动的部分就跟着手册来就行。</p>
<p>这里有一点，Shim 被硬编码为使用 grubx64.efi，但是由于我使用的 systemd-boot 作为 bootloader，没有 grubx64.efi，所以我选择了将 systemd-bootx64.efi 复制一个 grubx64.efi 出来。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cp /efi/EFI/systemd/systemd-bootx64.efi /efi/EFI/systemd/grubx64.efi</span></span></code></pre></div></div>
<h2 id="bwrap">bwrap</h2>
<p>沙盒程序就这两位我还算熟悉，<a href="https://github.com/netblue30/firejail" target="_blank" rel="noopener noreffer ">Firejail</a> 和 <a href="https://github.com/containers/bubblewrap" target="_blank" rel="noopener noreffer ">Bubblewrap</a>。前者有令人诟病的 setuid 安全隐患，后者没有 Firejail 那样有社区提供好的沙盒模板（即部分应用可以运行一个命令直接获得沙盒化，如 git，firefox 等）</p>
<p>我选择了 Bubblewrap（也就是标题中的 bwrap），目前只用到了浏览器和我的代码编辑器上，我目前的目标是，让使用的图形化软件基本都套一层 bwrap（除了终端模拟器）</p>
<p>对于到底应该 <code>--ro-bind</code> 什么文件，可以用 <code>strace -e openat</code> 看一下该程序到底尝试打开什么文件，然后决定到底要不要映射过去</p>
<h3 id="firefox">FireFox</h3>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">bwrap <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --new-session <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --symlink /usr/lib64 /lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --ro-bind /usr/lib /usr/lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --ro-bind /usr/lib64 /usr/lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --ro-bind /usr/bin /usr/bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    xdg-dbus-proxy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    unix:path<span class="o">=</span>/var/run/user/<span class="nv">$UID</span>/bus <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /run/user/<span class="nv">$UID</span>/.dbus-proxy/session-bus-proxy-6271 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --filter <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --own<span class="o">=</span><span class="s2">&#34;org.mpris.MediaPlayer2.firefox.*&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --own<span class="o">=</span><span class="s2">&#34;org.mozilla.firefox.*&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --own<span class="o">=</span><span class="s2">&#34;org.mozilla.firefox_beta.*&#34;</span> <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bwrap <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --symlink usr/lib /lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --symlink usr/lib64 /lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --symlink usr/bin /bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --symlink usr/bin /sbin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/lib /usr/lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/lib64 /usr/lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/bin /usr/bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /opt/bin /opt/bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/applications /usr/share/applications <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/gtk-3.0 /usr/share/gtk-3.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/icu /usr/share/icu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/drirc.d /usr/share/drirc.d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/fonts /usr/share/fonts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/glib-2.0 /usr/share/glib-2.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/glvnd /usr/share/glvnd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/icons /usr/share/icons <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/mime /usr/share/mime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/X11/xkb /usr/share/X11/xkb <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/icons /usr/share/icons <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/mime /usr/share/mime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/vulkan /usr/share/vulkan <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/egl /usr/share/egl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/nvidia /usr/share/nvidia <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /usr/share/ca-certificates /usr/share/ca-certificates <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /etc/ld.so.conf /etc/ld.so.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /etc/ld.so.cache /etc/ld.so.cache <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /etc/fonts /etc/fonts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /etc/resolv.conf /etc/resolv.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /etc/ssl /etc/ssl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /etc/ca-certificates.conf /etc/ca-certificates.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dir <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/pulse&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/pulse&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /run/user/<span class="nv">$UID</span>/bus /run/user/<span class="nv">$UID</span>/bus <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/wayland-1&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/wayland-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev /dev <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev-bind /dev/dri /dev/dri <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev-bind /dev/shm /dev/shm <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev-bind /dev/nvidia0 /dev/nvidia0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev-bind /dev/nvidiactl /dev/nvidiactl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev-bind /dev/nvidia-uvm /dev/nvidia-uvm <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --dev-bind /dev/nvidia-modeset /dev/nvidia-modeset <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind /sys /sys <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --proc /proc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --tmpfs /tmp <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind <span class="nv">$HOME</span>/.config/dconf <span class="nv">$HOME</span>/.config/dconf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --ro-bind <span class="nv">$HOME</span>/.config/user-dirs.dirs <span class="nv">$HOME</span>/.config/user-dirs.dirs <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --bind <span class="nv">$HOME</span>/.mozilla <span class="nv">$HOME</span>/.mozilla <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --bind <span class="nv">$HOME</span>/Downloads <span class="nv">$HOME</span>/Downloads <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --setenv GTK_THEME Papirus:light <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --setenv MOZ_ENABLE_WAYLAND <span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --setenv PATH /usr/bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --hostname RESTRICTED <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --unshare-all <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --share-net <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --die-with-parent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --new-session <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  /usr/bin/firefox <span class="nv">$@</span></span></span></code></pre></div></div>
<p>Chromium 的编译时间实在太长了（虽然 FireFox 的也没差到哪去，开启了 LTO 和 PGO 之后编译时间感人），我又用回来了这位</p>
<p>由于我有了其他软件从系统默认浏览器打开链接的需求，所以就用 xdg-dbus-proxy 设置了相关服务，并且我 waybar 的 mpris 组件也能显示 FireFox 播放的媒体了。</p>
<p>我使用了 nvidia-vaapi-driver，所以设备上暴露了一些 nvidia 的，这个 /dev/nvidia-uvm 一开始是没有的，我运行了 <code>vainfo</code> 之后就会出现，所以现在有一个抽象的事情就是我会先在 foot 上执行一遍 vainfo，之后打开 FireFox。这套是可以用上 nvidia-vaapi-driver 的硬件视频解码的，如果 FireFox 能支持 nvenc 就更好了。</p>
<h3 id="vscodium">VSCodium</h3>
<p>vscodium 基本照搬的 下面的 Chromium 的配置</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">bwrap <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/lib /lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/lib64 /lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/bin /bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/bin /sbin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/bin /usr/bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/lib /usr/lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/lib64 /usr/lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/applications /usr/share/applications <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/gtk-3.0 /usr/share/gtk-3.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/icu /usr/share/icu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/drirc.d /usr/share/drirc.d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/fonts /usr/share/fonts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/glib-2.0 /usr/share/glib-2.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/glvnd /usr/share/glvnd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/icons /usr/share/icons <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/mime /usr/share/mime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/X11/xkb /usr/share/X11/xkb <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/icons /usr/share/icons <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/locale /usr/share/locale <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/zoneinfo /usr/share/zoneinfo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/vulkan /usr/share/vulkan <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/verilator /usr/share/verilator <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/include /usr/include <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ssl /etc/ssl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ca-certificates.conf /etc/ca-certificates.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/fonts /etc/fonts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/resolv.conf /etc/resolv.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/chromium /etc/chromium <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/localtime /etc/localtime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ld.so.conf /etc/ld.so.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ld.so.cache /etc/ld.so.cache <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /opt/vscodium/ /opt/vscodium/ <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dir <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/wayland-1&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/wayland-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dev /dev <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dev-bind /dev/dri /dev/dri <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /sys/dev/char /sys/dev/char <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /sys/devices/pci0000:00 /sys/devices/pci0000:00 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--proc /proc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--tmpfs /tmp <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/.config/VSCodium <span class="nv">$HOME</span>/.config/VSCodium <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/.vscode-oss <span class="nv">$HOME</span>/.vscode-oss <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/Downloads <span class="nv">$HOME</span>/Downloads <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/Documents <span class="nv">$HOME</span>/Documents <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/codpjt <span class="nv">$HOME</span>/codpjt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/git_repo <span class="nv">$HOME</span>/git_repo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--setenv GTK_THEME Papirus:light <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--hostname RESTRICTED <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--unshare-all <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--share-net <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--new-session <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>/opt/vscodium/codium --ozone-platform<span class="o">=</span>wayland --use-gl<span class="o">=</span>angle --use-angle<span class="o">=</span>vulkan --enable-features<span class="o">=</span>AcceleratedVideoEncoder,AcceleratedVideoDecodeLinuxGL,VaapiOnNvidiaGPUs,VaapiIgnoreDriverChecks,Vulkan,DefaultANGLEVulkan,VulkanFromANGLE --ignore-gpu-blocklist --disable-gpu-driver-bug-workaround --enable-wayland-ime</span></span></code></pre></div></div>
<h3 id="chromium">Chromium</h3>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">bwrap <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/lib /lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/lib64 /lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/bin /bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--symlink usr/bin /sbin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/lib /usr/lib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/lib64 /usr/lib64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/bin /usr/bin <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ssl /etc/ssl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ca-certificates.conf /etc/ca-certificates.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/fonts /etc/fonts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/resolv.conf /etc/resolv.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/chromium /etc/chromium <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/localtime /etc/localtime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ld.so.conf /etc/ld.so.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /etc/ld.so.cache /etc/ld.so.cache <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/applications /usr/share/applications <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/gtk-3.0 /usr/share/gtk-3.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/icu /usr/share/icu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/drirc.d /usr/share/drirc.d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/fonts /usr/share/fonts <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/glib-2.0 /usr/share/glib-2.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/glvnd /usr/share/glvnd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/icons /usr/share/icons <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/mime /usr/share/mime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/X11/xkb /usr/share/X11/xkb <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/icons /usr/share/icons <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/mime /usr/share/mime <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/zoneinfo /usr/share/zoneinfo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/pixmaps /usr/share/pixmaps <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/locale /usr/share/locale <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /usr/share/vulkan /usr/share/vulkan <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dev /dev <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dev-bind /dev/dri /dev/dri <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--proc /proc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /sys/dev/char /sys/dev/char <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /sys/devices/pci0000:00 /sys/devices/pci0000:00 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind /run/dbus /run/dbus <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dir <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/wayland-1&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/wayland-1&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/pipewire-0&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/pipewire-0&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--ro-bind <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/pulse&#34;</span> <span class="s2">&#34;</span><span class="nv">$XDG_RUNTIME_DIR</span><span class="s2">/pulse&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--tmpfs /tmp <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--dir <span class="nv">$HOME</span>/.cache <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/.config/chromium <span class="nv">$HOME</span>/.config/chromium <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--bind <span class="nv">$HOME</span>/Downloads <span class="nv">$HOME</span>/Downloads <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--unshare-all <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--share-net <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--die-with-parent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--new-session <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>/usr/bin/chromium</span></span></code></pre></div></div>
<p>使用 FireFox 的时候还在用我的 NVIDIA 显卡驱动，由于 FireFox 官方并不支持 NVENC 视频解码（虽然可以通过安装 media-libs/nvidia-vaapi-driver 实现翻译）</p>
<p>由于使用 FireFox 打开部分网站速度不佳，我选择了 Chromium（由于 media-libs/libpng 依赖问题，我把 FireFox 删除了）</p>
<p>使用 Chromium 的时候是 Intel 的核显驱动，安装了 media-libs/libva-intel-media-driver 软件包，这套 bwrap 参数可以让 Chromium 用到显卡的视频解码，由于 Gentoo 的 Chromium 会读取 /etc/chromium/ 下的文件作为 Chromium 启动时的命令行参数，所以我把参数都放到那里了</p>
<p>我这套选项可能有的有些多余，不过我懒得再裁剪了</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-txt">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">--ozone-platform=wayland --use-gl=angle --use-angle=vulkan --enable-features=AcceleratedVideoEncoder,AcceleratedVideoDecodeLinuxGL,VaapiOnNvidiaGPUs,VaapiIgnoreDriverChecks,Vulkan,DefaultANGLEVulkan,VulkanFromANGLE --ignore-gpu-blocklist --disable-gpu-driver-bug-workaround --enable-wayland-ime --wayland-text-input-version=3</span></span></code></pre></div></div>
<h2 id="sysctl">sysctl</h2>
<p>我参考了一些文章给出的 sysctl 配置，新建目录 /etc/sysctl.d/，并新建文件 99-hardened.conf，文件内容如下：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-conf">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">core_pattern</span><span class="o">=|/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span>
</span></span><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">kptr_restrict</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">dmesg_restrict</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">unprivileged_bpf_disabled</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">bpf_jit_harden</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">dev</span><span class="o">.</span><span class="n">tty</span><span class="o">.</span><span class="n">ldisc_autoload</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">vm</span><span class="o">.</span><span class="n">unprivileged_userfaultfd</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">kexec_load_disabled</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">sysrq</span><span class="o">=</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_syncookies</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_rfc1337</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_timestamps</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">rp_filter</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">rp_filter</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">accept_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">accept_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">secure_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">secure_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">accept_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">accept_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">send_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">send_redirects</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">icmp_echo_ignore_all</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">accept_source_route</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">accept_source_route</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">accept_source_route</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">accept_source_route</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">use_tempaddr</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">use_tempaddr</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">accept_ra</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="o">.</span><span class="n">ipv6</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">accept_ra</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">kernel</span><span class="o">.</span><span class="n">yama</span><span class="o">.</span><span class="n">ptrace_scope</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">vm</span><span class="o">.</span><span class="n">mmap_rnd_bits</span><span class="o">=</span><span class="mi">32</span>
</span></span><span class="line"><span class="cl"><span class="n">vm</span><span class="o">.</span><span class="n">mmap_rnd_compat_bits</span><span class="o">=</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="n">fs</span><span class="o">.</span><span class="n">protected_symlinks</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">fs</span><span class="o">.</span><span class="n">protected_hardlinks</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">fs</span><span class="o">.</span><span class="n">protected_fifos</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">fs</span><span class="o">.</span><span class="n">protected_regular</span><span class="o">=</span><span class="mi">2</span></span></span></code></pre></div></div>
<p><code>kernel.yama.ptrace_scope=1</code> 貌似是默认的？为了更安全可以选择 <code>2</code> 或 <code>3</code>，我印象中 2 是不允许非 root 用户做这件事，而 3 这是不允许该行为</p>
<p>我设置为 1 是允许父子进程关系才可以查看进程的内存和运行状态等信息，这是因为我仍然有调试软件的需求，如果没有的话设置死也是个选择 🤔</p>
<p>可以安装 <a href="https://github.com/slimm609/checksec" target="_blank" rel="noopener noreffer ">checksec</a> 查看当前运行的 kernel 的安全性（当然，该工具检查的并不全面）</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ checksec --kernel 
</span></span><span class="line"><span class="cl">* Kernel protection information:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Description - List the status of kernel protection mechanisms. Rather than
</span></span><span class="line"><span class="cl">  inspect kernel mechanisms that may aid in the prevention of exploitation of
</span></span><span class="line"><span class="cl">  userspace processes, this option lists the status of kernel configuration
</span></span><span class="line"><span class="cl">  options that harden the kernel itself against attack.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Kernel config:
</span></span><span class="line"><span class="cl">/proc/config.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Vanilla Kernel ASLR:                    Full
</span></span><span class="line"><span class="cl">  NX protection:                          Enabled
</span></span><span class="line"><span class="cl">  Protected symlinks:                     Enabled
</span></span><span class="line"><span class="cl">  Protected hardlinks:                    Enabled
</span></span><span class="line"><span class="cl">  Protected fifos:                        Enabled
</span></span><span class="line"><span class="cl">  Protected regular:                      Enabled
</span></span><span class="line"><span class="cl">  Ipv4 reverse path filtering:            Enabled
</span></span><span class="line"><span class="cl">  Kernel heap randomization:              Enabled
</span></span><span class="line"><span class="cl">  GCC stack protector support:            Enabled
</span></span><span class="line"><span class="cl">  GCC stack protector strong:             Enabled
</span></span><span class="line"><span class="cl">  SLAB freelist randomization:            Enabled
</span></span><span class="line"><span class="cl">  Virtually-mapped kernel stack:          Enabled
</span></span><span class="line"><span class="cl">  Restrict /dev/mem access:               Enabled
</span></span><span class="line"><span class="cl">  Restrict I/O access to /dev/mem:        Enabled
</span></span><span class="line"><span class="cl">  Exec Shield:                            Unsupported
</span></span><span class="line"><span class="cl">  YAMA:                                   Active
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Hardened Usercopy:                      Enabled
</span></span><span class="line"><span class="cl">  Harden str/mem functions:               Enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* X86 only:            
</span></span><span class="line"><span class="cl">  Address space layout randomization:     Enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* SELinux:                                Disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  SELinux infomation available here: 
</span></span><span class="line"><span class="cl">    http://selinuxproject.org/</span></span></code></pre></div></div>
<p>这里除了 SELinux 没有开启之外，其他都是通过检查的</p>
<p>印象中还有一个项目，它检查内核配置比这个更全面，除了基本的这些之外，还有 <a href="https://kspp.github.io/" target="_blank" rel="noopener noreffer ">KSPP</a> (Kenrel Self Protection Project) 和 PAX 等项目的建议，不过我没用它</p>
<p><code>checksec</code> 还可以检查指定的可执行文件的安全配置情况</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ checksec --file<span class="o">=</span>/usr/bin/sway
</span></span><span class="line"><span class="cl">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	    Symbols	     FORTIFY	 Fortified  Fortifiable	FILE
</span></span><span class="line"><span class="cl">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols	Partial	9		18		/usr/bin/sway</span></span></code></pre></div></div>
<h2 id="内核命令行参数">内核命令行参数</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-txt">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">page_alloc.shuffle=1 pti=on vsyscall=none module.sig_enforce=1 lockdown=confidentiality quiet loglevel=0
</span></span><span class="line"><span class="cl">intel_iommu=on amd_iommu=force_isolation efi=disable_early_pci_dma iommu=force iommu.passthrough=0 iommu.strict=1
</span></span><span class="line"><span class="cl">spectre_v2=on spec_store_bypass_disable=on tsx=off tsx_async_abort=full mds=full l1tf=full,force kvm.nx_huge_pages=force</span></span></code></pre></div></div>
<p>第一行中的启动参数是开启一些常见的安全防护机制，比如页表隔离，模块签名验证等，其实有更多的参数可以写，比如 <code>slab_nomerge</code> 和 <code>randomize_kstack_offset=on</code> 这些，不过由于我使用的内核是 hardened USE 变量的 gentoo-kernel，这些已经在编译的时候开启了，我就不在这里写了</p>
<p>第二行是开启一些 IOMMU 防护</p>
<p>第三行是开启 Spectre 等 CPU 漏洞的缓解机制</p>
<p>如果要检查当前运行的 CPU 是否受到已知漏洞的影响，可以运行</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ grep -r . /sys/devices/system/cpu/vulnerabilities/</span></span></code></pre></div></div>
<h2 id="networkmanager">NetworkManager</h2>
<p>NetworkManager 是目前大多数用户使用的桌面环境都在用的网络管理工具，它既可以管理有线网络，也可以管理无线网络。</p>
<p>应该开启 NetworkManager 的 MAC 地址随机化</p>
<p>在 /etc/NetworkManager/conf.d/ 下创建 99-macrandomize.conf</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-conf">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[device]
</span></span><span class="line"><span class="cl">wifi.scan-rand-mac-address=yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[connection]
</span></span><span class="line"><span class="cl">wifi.cloned-mac-address=random
</span></span><span class="line"><span class="cl">ethernet.cloned-mac-address=random</span></span></code></pre></div></div>
<p>我使用的是 Hyprland 窗口管理器，这些窗口管理器基本都有一个缺陷 —— 没有自家的 keyring 服务（GNOME 有 gnome-keyring，KDE Plasma 有 kwallet）</p>
<p>我安装了 gnome-base/gnome-keyring，并且运行了 <code>systemctl --user enable --now gnome-keyring-daemon</code></p>
<p>之后我安装了 gnome-extra/nm-applet 用来连接 WIFI，并使用网络编辑，在 WIFI 安全性中改成仅为该用户存储密码</p>
<p>如果要安装 gnome-extra/nm-applet 的话，最好启用 <code>appindicator</code> USE 变量</p>
<p>之后是开启 IPV6 隐私扩展</p>
<p>新建 /etc/NetworkManager/conf.d/ip6-privacy.conf，其内容为</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-conf">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[connection]
</span></span><span class="line"><span class="cl">ipv6.ip6-privacy=2</span></span></code></pre></div></div>
<p>在 /etc/NetworkManager/system-connections/ 下编辑已有的连接</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-conf">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">[ipv6]
</span></span><span class="line"><span class="cl">method=auto
</span></span><span class="line"><span class="cl">ip6-privacy=2
</span></span><span class="line"><span class="cl">...</span></span></code></pre></div></div>
<p>添加这个 <code>ip6-privacy=2</code></p>
<h2 id="浏览器配置">浏览器配置</h2>
<p>FireFox 我推荐 <a href="https://github.com/arkenfox/user.js" target="_blank" rel="noopener noreffer ">arkenfox/user.js</a> 项目，搭配 <a href="https://github.com/gorhill/uBlock" target="_blank" rel="noopener noreffer ">uBlock Origin</a></p>
<p>如果为了防止被网站跟踪，可以选择使用 Mullvad Browser，这位是和 Tor Project 联合开发，并去除了 Tor 的部分</p>
<p>Chromium 的话，我选择根据 <a href="https://www.chromium.org/administrators/policy-templates/" target="_blank" rel="noopener noreffer ">Policy Templates</a> 配置一些策略</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-json">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;PrivacySandboxAdMeasurementEnabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;PrivacySandboxAdTopicsEnabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;PrivacySandboxPromptEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;PrivacySandboxSiteEnabledAdsEnabled&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;AudioSandboxEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;NetworkServiceSandboxEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;AutoplayAllowed&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;BlockThirdPartyCookies&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;SavingBrowserHistoryDisabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;EncryptedClientHelloEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;HttpsUpgradesEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;WebRtcIPHandling&#34;</span><span class="p">:</span> <span class="s2">&#34;disable_non_proxied_udp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;SafeBrowsingEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;SafeBrowsingProtectionLevel&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;SafeBrowsingProxiedRealTimeChecksAllowed&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;CACertificateManagementAllowed&#34;</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>写完可以用 <code>jq</code> 验证一下 JSON 格式对不对 <code>cat test.json | jq</code></p>
<p>我在 Chromium 上依旧在使用 uBlock Origin，也不知道 Chromium 什么时候开始停止支持 Mainfest V2 标准的浏览器扩展</p>
<h2 id="禁用-core-dump">禁用 core dump</h2>
<p>禁用 core dump 貌似是为了防止有写私密数据也被 dump 下来了。不过就我个人而言，我只是很讨厌这种在我不知道的时候 dump 的行为，不知不觉运行 <code>coredumpctl</code> 一看，python、firefox 这些软件都 dump 过，难绷。</p>
<p>新建 /etc/systemd/coredump.conf.d/disable.conf 中写入</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-conf">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[Coredump]
</span></span><span class="line"><span class="cl">Storage=none
</span></span><span class="line"><span class="cl">ProcessSizeMax=0</span></span></code></pre></div></div>
<p>上面 sysctl 的 <code>kernel.core_pattern=|/bin/false</code> 也是在禁用 core dump</p>
<p>不得不说，禁用了之后，我自己开发的软件 core dump 了也没存。有一说一，core dump 还是有助于开发的，等之后我手动临时开启试试看吧。</p>
<h2 id="面向安全的编译选项">面向安全的编译选项</h2>
<p>在我最先写这个文章的时候，我就想写这部分，但是由于我对 GCC 和 LLVM 的了解还太少，导致我有些迟疑（当然，现在也了解不多，只是感觉应该加上而已）</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-conf">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">COMMON_FLAGS=&#34;-O3 -pipe -march=x86-64-v3 -flto=thin -fstack-protector-strong -fstack-clash-protection -fcf-protection=full -D_FORTIFY_SOURCE=3&#34;
</span></span><span class="line"><span class="cl">RUSTFLAGS=&#34;${RUSTFLAGS} -C target-cpu=native&#34;
</span></span><span class="line"><span class="cl">CFLAGS=&#34;${COMMON_FLAGS}&#34;
</span></span><span class="line"><span class="cl">CXXFLAGS=&#34;${COMMON_FLAGS}&#34;
</span></span><span class="line"><span class="cl">FCFLAGS=&#34;${COMMON_FLAGS}&#34;
</span></span><span class="line"><span class="cl">FFLAGS=&#34;${COMMON_FLAGS}&#34;
</span></span><span class="line"><span class="cl">LDFLAGS=&#34;-Wl,-O3,-z,now,--as-needed,--lto-O3,--icf=safe,--gc-sections&#34;</span></span></code></pre></div></div>
<p>我使用的是 LLVM/systemd profile，所以这里用了 thinlto</p>
<p>上面就是我个人的编译选项了，我本身就开启了 <code>hardened</code> USE 变量，说实话，这里的部分 USE 变量是重复的</p>
<p>只要开启了 <code>hardened</code> USE 变量，这里面有些选项是默认就加上的</p>
<blockquote>
<p>运行 <code>clang --version</code> 可以看到</p>
<p>Configuration file: /etc/clang/x86_64-pc-linux-gnu-clang.cfg</p>
<p>从那个文件中可以看到它依赖于 @gentoo-common.cfg @gentoo-common-ld.cfg 和 @gentoo-cet.cfg</p>
<p>我这里的 -fstack-clash-protection -fstack-protector-strong -fcf-protection=all 在在上面的文件中</p>
</blockquote>
<p><code>fstack-protector-*</code> 都是对栈溢出的防御，而 <code>fcf-protection</code> 则是对控制流劫持（也不知道是不是这个名字，就是 ROP 之类的）攻击的防御</p>
<p>LLVM 中也有一个应对 ROP 这种攻击的技术，就是 <a href="https://clang.llvm.org/docs/ControlFlowIntegrity.html" target="_blank" rel="noopener noreffer ">CFI</a>，CFI 必须在开启了 LTO 的情况下才能使用（我印象中 KCFI 不需要 LTO，它被用在操作系统内核等底层软件，检测的范围更小），我感觉为特定的软件开 CFI，倒也可以接受。Linux kernel 有专门的 CFI 的选项，Chromium 也实施了 CFI。</p>
<p>CFI 还分前端和后端，我也没太仔细研究，也不太清楚区别</p>
<p>我使用了 <code>O3</code> 编译，虽然说 O3 的提升空间不大，不过我个人希望试试看。</p>
<p><code>march=x86-64-v3</code> 表示了我本机 CPU 的指令集是这位，其实用 <code>march=native</code> 就行，编译器会自动选择适合的指令集</p>
<p><code>D_FORTIFY_SOURCE=3</code> 用于应用 libc 的一种强化措施，主要用于检测某些库函数的缓冲区溢出问题。具体可以参考 glibc 的文档：https://www.gnu.org/software/libc/manual/html_node/Source-Fortification.html</p>
<h2 id="selinuxapparmor">SELinux/AppArmor</h2>
<p>TODO 我自己还没太准备学习这二位</p>
]]></description>
</item>
<item>
    <title>在 Gentoo Linux 上尝试 musl libc &#43; llvm 环境</title>
    <link>http://localhost:1313/posts/gentoo_musl_llvm/</link>
    <pubDate>Mon, 05 Aug 2024 09:34:33 &#43;0000</pubDate>
    <author>suo yuan</author>
    <guid>http://localhost:1313/posts/gentoo_musl_llvm/</guid>
    <description><![CDATA[<p>尝试使用选择了 musl/llvm 的 profile 的 Gentoo Linux 作为日常使用的桌面操作系统</p>
<h1 id="在-gentooo-linux-上尝试-musl-libc--llvm-环境">在 Gentooo Linux 上尝试 musl libc + llvm 环境</h1>
<h2 id="背景">背景</h2>
<p>以前就有听说过 musl libc 了，一个体积小，并且完全按照标准实现的 libc，但一直没想过使用这个 libc。前几天看到 Gentoo Linux 对于 musl libc 有很多 profile 可以使用（不过都是实验性的，而非 stable）。</p>
<p>一定程度上这完成了<a href="../gentooinstall_ng/" rel="">之前安装 Gentoo Linux 的文章</a>中的目标:</p>
<blockquote>
<p>我在安装前的预计其实是用 Gentoo Linux，同时 init 使用 openrc，默认编译工具链用 clang/llvm，用 hardened profile 并且开一些额外的编译选项（比如 thinlto 之类的）。不过目前只实现了使用 openrc 和 hardened profile。</p>
</blockquote>
<p>之前那次我没有实现这些目标，只是使用了 openrc，这次我使用这个 profile 确实实现了这一点，因为 systemd 依赖于 glibc，所以我选择使用 openrc，默认编译工具链就是 clang/llvm，甚至 C++ 标准库使用的也是提供的 <a href="https://libcxx.llvm.org/" target="_blank" rel="noopener noreffer ">libc++</a>，因为默认用 clang/llvm 编译，所以我直接默认就开启了 thinlto。</p>
<h2 id="安装前">安装前</h2>
<p><a href="https://www.etalabs.net/compare_libcs.html" target="_blank" rel="noopener noreffer ">musl libc 的作者提供了一个 musl uClibc glibc dietlibc 之间的比较</a>，musl libc 体积上确实小，不过部分库函数的性能不如 glibc。并且由于 glibc 中存在 GNU 的一些扩展，导致 musl libc 和 glibc 不能完全兼容，一些依赖于 glibc 的闭源发行二进制软件包的程序可能无法运行在 musl libc 上，不过可以尝试使用flatpak 运行。</p>
<p>Chromium 浏览器无法使用 musl libc 编译，electorn 的也无法使用。一定程度上，这迫使一直用 Visual Studio Code 的我开始使用 neovim。</p>
<p>musl libc 支持的 locale 还不是很多：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-txt">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">  [1]   C
</span></span><span class="line"><span class="cl">  [2]   C.UTF-8
</span></span><span class="line"><span class="cl">  [3]   sr_RS.UTF-8
</span></span><span class="line"><span class="cl">  [4]   cs_CZ.UTF-8
</span></span><span class="line"><span class="cl">  [5]   nb_NO.UTF-8
</span></span><span class="line"><span class="cl">  [6]   de_DE.UTF-8
</span></span><span class="line"><span class="cl">  [7]   sv_SE.UTF-8
</span></span><span class="line"><span class="cl">  [8]   nl_NL.UTF-8
</span></span><span class="line"><span class="cl">  [9]   fr_FR.UTF-8
</span></span><span class="line"><span class="cl">  [10]  fi_FI.UTF-8
</span></span><span class="line"><span class="cl">  [11]  en_GB.UTF-8
</span></span><span class="line"><span class="cl">  [12]  it_IT.UTF-8
</span></span><span class="line"><span class="cl">  [13]  pt_PT.UTF-8
</span></span><span class="line"><span class="cl">  [14]  en_US.UTF-8 *
</span></span><span class="line"><span class="cl">  [15]  de_CH.UTF-8
</span></span><span class="line"><span class="cl">  [16]  es_ES.UTF-8
</span></span><span class="line"><span class="cl">  [17]  pt_BR.UTF-8
</span></span><span class="line"><span class="cl">  [18]  ru_RU.UTF-8</span></span></code></pre></div></div>
<p>这里没有 zh_CN.UTF-8。</p>
<p>musl libc 设置时区的方式也会有所不同，需要在 <strong>/etc/env.d/00musl</strong> 文件中写好 <code>TZ</code> 环境变量。</p>
<p>以上关于 locale 和时区的设置，<a href="https://wiki.gentoo.org/wiki/Musl_usage_guide" target="_blank" rel="noopener noreffer ">Gentoo wiki</a> 都有说明。在 <a href="https://wiki.gentoo.org/wiki/Musl_porting_notes" target="_blank" rel="noopener noreffer ">Gentoo 的另一篇 wiki</a> 记录了一些常见的 musl libc 编译可能遇到的问题（即编译那些一定程度上依赖于 glibc 的软件）。</p>
<h2 id="安装时遇到的问题">安装时遇到的问题</h2>
<p>一开始装完后，进入 grub，进入 openrc 后就没后续了，之后重新装一编就没有遇到这个问题。不好评价这个问题的原因。</p>
<p>不知道是不是我这个内核版本的原因，我用 openrc 从来没有正常关机过，直接死在那里，后来我换到 stable 内核就没有这个问题了。</p>
<p>firefox-115 esr 版本无法正常编译，会报一些错误类似: <code>ld.lld: error: undefined hidden symbol</code>。详情可以参考 GitHub 上 <a href="https://github.com/llvm/llvm-project/issues/79027" target="_blank" rel="noopener noreffer ">LLVM 的 issue</a> 以及 <a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=276746" target="_blank" rel="noopener noreffer ">FreeBSD Bugzilla</a> 上的讨论。而且 <code>rust</code> 编译的部分也会出现问题。</p>
<p>我参考了 FreeBSD 上的解法，首先是 <code>rust</code> 那里，根据 FreeBSD Bugzilla 上的讨论，原因是:</p>
<blockquote>
<p>rust-bindgen uses some tricks to generate bindings for C++ components, but gets confused by some new constructs in libc++ 18 headers, causing it to generate faulty binding code.</p>
</blockquote>
<p>该问题已经被<a href="https://hg.mozilla.org/mozilla-central/rev/9e96d1447f6c" target="_blank" rel="noopener noreffer ">今年 1 月份的补丁</a> 解决，对此我选择不用 esr 版本，用 stable 的版本。</p>
<p>其次对于 undefined hidden symbol 的问题，则是为 firefox 的编译单独创建一个环境。在 <strong>/etc/portage/env/</strong> 目录下创建一个 <strong>compiler-clang-firefox</strong> 文件，文件内容是:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-txt">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">COMMON_FLAGS=&#34;-O2 -march=x86-64-v3 -pipe -fvisibility=hidden -fvisibility-inlines-hidden&#34;
</span></span><span class="line"><span class="cl">CLAGS=&#34;${COMMON_FLAGS}&#34;
</span></span><span class="line"><span class="cl">CXXFLAGS=&#34;${COMMON_FLAGS}&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CC=&#34;clang&#34;
</span></span><span class="line"><span class="cl">CXX=&#34;clang++&#34;
</span></span><span class="line"><span class="cl">CPP=&#34;clang-cpp&#34;
</span></span><span class="line"><span class="cl">AR=&#34;llvm-ar&#34;
</span></span><span class="line"><span class="cl">NM=&#34;llvm-nm&#34;
</span></span><span class="line"><span class="cl">RANLIB=&#34;
</span></span><span class="line"><span class="cl">llvm-ranlib&#34;</span></span></code></pre></div></div>
<p>也就是 CXXFLAGS 加上 <code>-fvisibility=hidden -fvisibility-inlines-hidden</code></p>
<p>新建 <strong>/etc/portage/package.env/</strong> 目录，在其中新建一个文件写入:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-txt">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">www-client/firefox compiler-clang-firefox</span></span></code></pre></div></div>
<p>这样就可以使用指定的编译环境编译了。</p>
<p>对于 <a href="https://packages.gentoo.org/packages/dev-libs/darts" target="_blank" rel="noopener noreffer ">dev-libs/darts</a> 来说，由于 <strong>src/lexicon.h</strong> 中的 <code>std::random_shuffle</code> 在 <code>std</code> 中已经不存在，<a href="https://en.cppreference.com/w/cpp/algorithm/random_shuffle" target="_blank" rel="noopener noreffer ">cppreference</a> 中也可以看到，该函数 从 C++ 17 开始就废除了。所以我给它写了个 patch。</p>
<p>在 <strong>/etc/portage/</strong> 目录下新建一个 <strong>patches</strong> 的文件夹，然后在 <strong>patches</strong> 里新建 <strong>dev-libs/darts</strong> 这两级文件夹，之后把补丁放进去，安装的时候会自动 patch。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-patch">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-patch" data-lang="patch"><span class="line"><span class="cl"><span class="gh">diff --git a/src/lexicon.h b/src/lexicon.h
</span></span></span><span class="line"><span class="cl"><span class="gh">index a2935f4..2a30d1b 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/lexicon.h
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/lexicon.h
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1,3 +1,4 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span><span class="gi">+// clang-format off
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> #ifndef DARTS_LEXICON_H_
</span></span><span class="line"><span class="cl"> #define DARTS_LEXICON_H_
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gu">@@ -7,6 +8,7 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> #include &lt;ctime&gt;
</span></span><span class="line"><span class="cl"> #include &lt;iostream&gt;
</span></span><span class="line"><span class="cl"> #include &lt;limits&gt;
</span></span><span class="line"><span class="cl"><span class="gi">+#include &lt;random&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> #include &lt;vector&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> #include &#34;./mersenne-twister.h&#34;
</span></span><span class="line"><span class="cl"><span class="gu">@@ -58,9 +60,9 @@ class Lexicon {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   }
</span></span><span class="line"><span class="cl">   // randomize() shuffles keys. Values are not affected.
</span></span><span class="line"><span class="cl">   void randomize() {
</span></span><span class="line"><span class="cl"><span class="gd">-    Darts::MersenneTwister mt(
</span></span></span><span class="line"><span class="cl"><span class="gd">-        static_cast&lt;Darts::MersenneTwister::int_type&gt;(std::time(NULL)));
</span></span></span><span class="line"><span class="cl"><span class="gd">-    std::random_shuffle(keys_.begin(), keys_.end(), mt);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+    std::random_device rd;
</span></span></span><span class="line"><span class="cl"><span class="gi">+    std::mt19937 g(rd());
</span></span></span><span class="line"><span class="cl"><span class="gi">+    std::shuffle(keys_.begin(), keys_.end(), g);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   void split();
</span></span></code></pre></div></div>
<p>我开头有 <code>// clang-format off</code> 的原因是我的 neovim 会保存时候自动调用 clang-format 格式化。</p>
<p>如果遇到了 Hyprland 0.42 编译失败的情况，报错是 <code>copy_if</code> 等函数没有找到，可以使用我找到的这个 patch</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-patch">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-patch" data-lang="patch"><span class="line"><span class="cl">From eb42adc4c090918ad6be9fcb24066da8cdfd9bd0 Mon Sep 17 00:00:00 2001
</span></span><span class="line"><span class="cl">From: Serenity Braesch &lt;Serenity.Braesch@proton.me&gt;
</span></span><span class="line"><span class="cl">Date: Sat, 24 Aug 2024 01:53:08 -0600
</span></span><span class="line"><span class="cl">Subject: [PATCH] Fix missing include needed by clang
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gs">---
</span></span></span><span class="line"><span class="cl"><span class="gs"></span> src/managers/XCursorManager.cpp | 1 +
</span></span><span class="line"><span class="cl"> 1 file changed, 1 insertion(+)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/managers/XCursorManager.cpp b/src/managers/XCursorManager.cpp
</span></span></span><span class="line"><span class="cl"><span class="gh">index 7fc21a28..1e7ca535 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/managers/XCursorManager.cpp
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/managers/XCursorManager.cpp
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1,3 +1,4 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span><span class="gi">+#include &lt;algorithm&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> #include &lt;cstring&gt;
</span></span><span class="line"><span class="cl"> #include &lt;dirent.h&gt;
</span></span><span class="line"><span class="cl"> #include &lt;filesystem&gt;
</span></span><span class="line"><span class="cl"><span class="gd">-- 
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>2.44.2
</span></span></code></pre></div></div>
<p>这已经被 <a href="https://github.com/hyprwm/Hyprland/pull/7490" target="_blank" rel="noopener noreffer ">合并到 Hyprland 主线</a> 里了，等下一个版本应该就没这个事情了。</p>
<h2 id="后记">后记</h2>
<p>我没有尝试什么桌面环境，本身我这台计算机的性能就没强到哪去，所以我安装了 sway，还算正常。后来还是用了 Hyprland，xdg-desktop-portal-hyprland 这个软件是 guru 仓库内的，好家伙。</p>]]></description>
</item>
<item>
    <title>我写的 Gentoo Linux 安装指南</title>
    <link>http://localhost:1313/posts/gentooinstall_ng/</link>
    <pubDate>Thu, 28 Mar 2024 20:05:47 &#43;0000</pubDate>
    <author>suo yuan</author>
    <guid>http://localhost:1313/posts/gentooinstall_ng/</guid>
    <description><![CDATA[<p>我这次安装 Gentoo Linux 做的额外的工作，也就是除官方文档之外的安装步骤。这里我用的 init 是 openrc，WM 用的是 Hyprland</p>
<h1 id="我写的-gentoo-linux-安装指南">我写的 Gentoo Linux 安装指南</h1>
<h2 id="背景">背景</h2>
<p>我这次安装主要因为 Gentoo Linux 在我看来真的很有趣，并且我想尝试一些新的东西试试，虽然我用 Arch Linux 应该不会遇到滚挂的问题，但我还是有些疑虑。</p>
<p>我在安装前的预计其实是用 Gentoo Linux，同时 init 使用 openrc，默认编译工具链用 clang/llvm，用 hardened profile 并且开一些额外的编译选项（比如 thinlto 之类的）。不过目前只实现了使用 openrc 和 hardened profile。</p>
<h2 id="profile-选择">profile 选择</h2>
<p>根据 <a href="https://www.gentoo.org/support/news-items/2024-03-22-new-23-profiles.html" target="_blank" rel="noopener noreffer ">Gentoo Linux 在 24 年 3 月发布的 news</a>，profile 17.1 等版本已经过时了，最好应该更新到 23.0。如果你的 stage3 包下载的是 systemd 什么的，那就直接 enable 23.0 的 profile，如果你上来就选择了 openrc 相关的 profile，貌似还是 17.1 的。你需要更换到对应 23.0 中的那些 split-usr 的 profile。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ eselect profile list <span class="p">|</span> grep 23.0
</span></span><span class="line"><span class="cl">  <span class="o">[</span>21<span class="o">]</span>  default/linux/amd64/23.0 <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>22<span class="o">]</span>  default/linux/amd64/23.0/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>23<span class="o">]</span>  default/linux/amd64/23.0/desktop <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>24<span class="o">]</span>  default/linux/amd64/23.0/desktop/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>25<span class="o">]</span>  default/linux/amd64/23.0/desktop/gnome <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>26<span class="o">]</span>  default/linux/amd64/23.0/desktop/gnome/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>27<span class="o">]</span>  default/linux/amd64/23.0/desktop/plasma <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>28<span class="o">]</span>  default/linux/amd64/23.0/desktop/plasma/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>29<span class="o">]</span>  default/linux/amd64/23.0/no-multilib <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>30<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>31<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/hardened <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>32<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/hardened/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>33<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/hardened/selinux <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>34<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/hardened/selinux/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>35<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/prefix <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>36<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/prefix/kernel-2.6.32+ <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>37<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/prefix/kernel-2.6.16+ <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>38<span class="o">]</span>  default/linux/amd64/23.0/no-multilib/prefix/kernel-3.2+ <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>39<span class="o">]</span>  default/linux/amd64/23.0/llvm <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>40<span class="o">]</span>  default/linux/amd64/23.0/llvm/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>41<span class="o">]</span>  default/linux/amd64/23.0/hardened <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>42<span class="o">]</span>  default/linux/amd64/23.0/hardened/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>43<span class="o">]</span>  default/linux/amd64/23.0/hardened/selinux <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>44<span class="o">]</span>  default/linux/amd64/23.0/hardened/selinux/systemd <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>45<span class="o">]</span>  default/linux/amd64/23.0/split-usr <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>46<span class="o">]</span>  default/linux/amd64/23.0/split-usr/desktop <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>47<span class="o">]</span>  default/linux/amd64/23.0/split-usr/desktop/gnome <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>48<span class="o">]</span>  default/linux/amd64/23.0/split-usr/desktop/plasma <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>49<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>50<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/selinux <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>51<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/hardened <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>52<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/hardened/selinux <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>53<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/prefix <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>54<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/prefix/kernel-2.6.32+ <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>55<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/prefix/kernel-2.6.16+ <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>56<span class="o">]</span>  default/linux/amd64/23.0/split-usr/no-multilib/prefix/kernel-3.2+ <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>57<span class="o">]</span>  default/linux/amd64/23.0/split-usr/llvm <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>58<span class="o">]</span>  default/linux/amd64/23.0/split-usr/hardened <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>59<span class="o">]</span>  default/linux/amd64/23.0/split-usr/hardened/selinux <span class="o">(</span>stable<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>62<span class="o">]</span>  default/linux/amd64/23.0/x32 <span class="o">(</span>dev<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>63<span class="o">]</span>  default/linux/amd64/23.0/x32/systemd <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>64<span class="o">]</span>  default/linux/amd64/23.0/split-usr/x32 <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>69<span class="o">]</span>  default/linux/amd64/23.0/musl <span class="o">(</span>dev<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>70<span class="o">]</span>  default/linux/amd64/23.0/musl/llvm <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>71<span class="o">]</span>  default/linux/amd64/23.0/musl/hardened <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>72<span class="o">]</span>  default/linux/amd64/23.0/musl/hardened/selinux <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>73<span class="o">]</span>  default/linux/amd64/23.0/split-usr/musl <span class="o">(</span>dev<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>74<span class="o">]</span>  default/linux/amd64/23.0/split-usr/musl/llvm <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>75<span class="o">]</span>  default/linux/amd64/23.0/split-usr/musl/hardened <span class="o">(</span>exp<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>76<span class="o">]</span>  default/linux/amd64/23.0/split-usr/musl/hardened/selinux <span class="o">(</span>exp<span class="o">)</span></span></span></code></pre></div></div>
<p>为什么这里说 <em>split-usr</em>，在 <a href="https://wiki.gentoo.org/wiki/Merge-usr" target="_blank" rel="noopener noreffer ">merge-usr</a> 这篇 wiki 中指出，merge-usr 对于&gt;=systemd 255 来说是必需的，对于其他 init 系统来说是可选的。23.0 的除了标明 <em>split-usr</em> 默认都是 <em>merge-usr</em> 的，所以如果我目前使用的是 openrc，文件的布局默认就是 <em>split-usr</em>，也就先不更改了。</p>
<p>对我来说，我除了要 enable desktop 的 profile 之外，我还想要 enable hardened 的 profile 以带来安全上的提升。可以在<a href="https://wiki.gentoo.org/wiki/Profile_%28Portage%29#Example_1:_Combining_multiple_profiles_from_the_Gentoo_ebuild_repository" target="_blank" rel="noopener noreffer ">Gentoo Wiki 上关于 profile 的介绍中</a>查看到如何将两个 profile 同时 enable</p>
<p>说起安全性，Gentoo Linux 目前跟的是 LTS 的内核，版本目前在 6.6，不过 6.7 在安全性貌似有很多改进（存疑），所以我选择跟进 stable 的脚步（</p>
<p><a href="https://wiki.gentoo.org/wiki/Project:Hardened" target="_blank" rel="noopener noreffer ">Project:Hardened</a> 这个项目主页介绍了 Gentoo Hardened profile 的一些细节，但是这篇文档质量貌似不是很好。</p>
<h2 id="wm-选择">WM 选择</h2>
<p>使用的是 openrc，但我网络方面依旧选择的是 networkmanager，主要因为习惯了，其他的像 iwd，或者 wpa_supplicant 这样的 WiFi 连接工具我用的都不是很习惯（主要我是要用桌面环境的，这俩我都不知道有 tui 或者 gui 组件）。音频服务方面选择的是 pipewire，我并不想用 pulseaudio，所以只能选择 pipewire 了。根据<a href="https://wiki.gentoo.org/wiki/PipeWire" target="_blank" rel="noopener noreffer ">Gentoo Wiki 关于 PipeWire 的描述</a>，可以看出这东西还有点依赖 systemd，难绷。虽然 wiki 中关于 openrc 也给了使用它的方法。</p>
<p>DE 方面，我本来是想用 GNOME 的，虽然 GNOME 依赖于 systemd，但是 Gentoo Linux 做了一些工作使得可以在 openrc 上使用 GNOME，但是 GNOME 需要编译好多软件，我真的受不了了。我基于 “我真的喜欢用 Wayland” 的心理，选择使用了 Hyprland，WM 向来要比 DE 默认少装很多软件。</p>
<p>关于 Hyprland 的启动，我还是推荐 <code>dbus-run-session Hyprland</code> 这样启动，而不是直接 <code>Hyprland</code>。状态栏我是用的是 waybar，通知组件用的是 mako，程序启动器使用的是 wofi，Terminal 使用的是 kitty。输入法使用的是 fcitx5。</p>
<p>在 GNOME 中，使用 chromium 内核的软件以 Wayland 启动的话就无法使用中文输入法，需要附加 <code>--gtk-version=4</code> 这个 flag 才能使用，但是 Electron 的应用目前还不支持 gtk4 导致附加了 flag 也不好使。</p>
<p>但是在 Hyprland 中就没有这个问题，就像是 KDE Plasma 中也不会存在这个问题一样。只需要附加 <code>--enable-wayland-ime</code> 这个 flag 就可以了。</p>
<p>Chromium 内核的软件以 Wayland 启动的话会很模糊，附加 <code>--use-gl=egl</code> 就好了。</p>
<p>Hyprland 没有太好的主题设置软件，我选择的是使用 <code>gsettings</code> 这个软件</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gsettings get org.gnome.desktop.interface font-name
</span></span><span class="line"><span class="cl"><span class="s1">&#39;Noto Sans Mono 11&#39;</span>
</span></span><span class="line"><span class="cl">$ gsettings get org.gnome.desktop.interface icon-theme
</span></span><span class="line"><span class="cl"><span class="s1">&#39;Tela&#39;</span></span></span></code></pre></div></div>
<p>如果把 <code>get</code> 改成 <code>set</code> 就是设置字体和主题了。</p>]]></description>
</item>
</channel>
</rss>
